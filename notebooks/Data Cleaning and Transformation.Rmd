---
title: "Datathon Internal EDA"
author: "Helitha Dharmadasa - z5451805"
date: "2024-10-01"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library("tidyverse")
library("AER")
library("stringr")
```

## Read Data

```{r}
claims_data <- read_csv('../data/internal/UNSW_claims_data.csv', col_names = TRUE)

earned_data <- read_csv('../data/internal/UNSW_earned_data_adjusted_Sep27.csv', col_names = TRUE)
```

```{r}
# Some cleaning
# Remove negative tenures (makes no sense)
# Remove 0 total claim amounts
claims_data <- claims_data %>% filter(tenure >= 0) %>% filter(total_claim_amount > 0)

claims_data <- claims_data %>%
  filter(!str_detect(claim_status, "not_paid"))
```

```{r}
# Remove negative tenures
earned_data <- earned_data %>% filter(tenure >= 0)

# Clean up pet_de_sexed_age factorsx
earned_data <- earned_data %>%
  mutate(pet_de_sexed_age = case_when(
    str_detect(pet_de_sexed_age, "0-3") ~ "0-3 months",
    str_detect(pet_de_sexed_age, "4-6") ~ "4-6 months",
    str_detect(pet_de_sexed_age, "7-12") ~ "7-12 months",
    str_detect(pet_de_sexed_age, "1-2") ~ "1-2 years",
    str_detect(pet_de_sexed_age, "2\\+") ~ "2+ years"
  )) %>%
  replace_na(list(pet_de_sexed_age = "FALSE"))

# Replace missing breed traits with unknown
earned_data <- earned_data %>%
  replace_na(list(nb_breed_trait = "unknown"))

# Replace missing switcher status with FALSE
earned_data <- earned_data %>%
  replace_na(list(pet_is_switcher = FALSE))

# Remove rows with missing owner DOB
earned_data <- earned_data %>%
  filter(!is.na(person_dob))
```



# Claims
```{r}
claims_count <- claims_data %>% 
  group_by(exposure_id, tenure) %>% 
  summarise(claim_count = n(), .groups = 'drop')

frequency_df <- full_join(earned_data, claims_count, by = c("exposure_id", "tenure"))

frequency_df <- frequency_df %>%
  mutate(claim_count = replace_na(claim_count, 0),
         claim_count_indicator = ifelse(claim_count > 0, 1, 0))
```


```{r}
#Probably select(c("exposure_id", "tenure", "total_claim_amount"))
severity_df <- left_join(claims_data, earned_data, by = c("exposure_id", "tenure"))

#total claim amount = claim Paid / contribution + excess / gst
#167.07/0.9+100/1.1
#claim paid = (total claim amount - excess / gst ) * contribution

severity_df <- severity_df %>%
  group_by(condition_category, exposure_id) %>%
  mutate(excess_flag = ifelse(row_number() == 1, 1, 0)) %>%
  ungroup()

severity_df <- severity_df %>% 
  mutate(claim_due_excess = (total_claim_amount - (nb_excess)/1.1)*(nb_contribution/100),
         claim_due_no_excess = total_claim_amount*(nb_contribution/100)) %>%
  arrange(claim_start_date, exposure_id, claim_id) 
```


```{r}
tweedie_df <- claims_data %>% 
  select(c("exposure_id", "tenure", "total_claim_amount")) %>%
  full_join(earned_data, by = c("exposure_id", "tenure")) %>%
  mutate(total_claim_amount = replace_na(total_claim_amount, 0))
```


```{r}
write_csv(frequency_df, "../data/internal/frequency.csv")

write_csv(severity_df, "../data/internal/severity.csv")

write_csv(tweedie_df, "../data/internal/tweedie.csv")
```


```{r}
summary(tweedie_df)
```




















