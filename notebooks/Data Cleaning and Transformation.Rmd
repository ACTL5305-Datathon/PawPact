---
title: "Data Cleaning and Transformation"
author: "Helitha Dharmadasa - z5451805"
date: "2024-10-01"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library("tidyverse")
library("AER")
library("stringr")
```

## Read Data

```{r}
claims_data <- read_csv('../data/internal/UNSW_claims_data.csv', col_names = TRUE)

earned_data <- read_csv('../data/internal/UNSW_earned_data_adjusted_Sep27.csv', col_names = TRUE)
```


```{r}


```

# Claims Data Cleaning

```{r}
# Some cleaning
# Remove negative tenures (makes no sense)
# Remove 0 total claim amounts
claims_data <- claims_data %>% filter(tenure >= 0) %>% filter(total_claim_amount > 0)

claims_data <- claims_data %>%
  filter(!str_detect(claim_status, "not_paid"))

# Get rid of duplicates across all columns - probably errors
claims_data <- claims_data %>%
  distinct()

# Group remaining duplicate claim_ids
claims_data <- claims_data %>%
  group_by(claim_start_date, claim_id, tenure, exposure_id) %>%
  summarise(claim_status = paste(unique(claim_status), collapse = ", "),
            condition_category = paste(unique(condition_category), collapse = ", "),  
            claim_paid = sum(claim_paid),
            total_claim_amount = sum(total_claim_amount))
```

# Earned Data Cleaning

```{r}
# Remove useless first column
earned_data <- earned_data %>%
  select(-c("...1"))

# Remove negative tenures
earned_data <- earned_data %>%
  filter(tenure >= 0)

# Clean up pet_de_sexed_age factorsx
earned_data <- earned_data %>%
  mutate(pet_de_sexed_age = case_when(
    str_detect(pet_de_sexed_age, "0-3") ~ "0-3 months",
    str_detect(pet_de_sexed_age, "4-6") ~ "4-6 months",
    str_detect(pet_de_sexed_age, "7-12") ~ "7-12 months",
    str_detect(pet_de_sexed_age, "1-2") ~ "1-2 years",
    str_detect(pet_de_sexed_age, "2\\+") ~ "2+ years"
  )) %>%
  replace_na(list(pet_de_sexed_age = "FALSE"))

# Replace missing breed traits with unknown
earned_data <- earned_data %>%
  replace_na(list(nb_breed_trait = "unknown"))

# Replace missing switcher status with FALSE
earned_data <- earned_data %>%
  replace_na(list(pet_is_switcher = FALSE))

# Compute median ages by postcode
age_df <- earned_data %>%
  group_by(nb_postcode) %>%
  summarise(median_age = floor(median(owner_age_years, na.rm = TRUE)))

# Impute age and DoB using median, DoB is clunky but we won't use anyway
earned_data <- earned_data %>%
  left_join(age_df, by="nb_postcode") %>%
  mutate(owner_age_years = coalesce(owner_age_years, median_age)) %>%
  mutate(person_dob = coalesce(person_dob, as.Date(paste0(2024 - owner_age_years, "-01-01")))) %>%
  select(-median_age)
```

```{r}
medianincome <-read_csv('../data/external/MedianInc.csv')


# Perform a left join (UNSW earned data left join with external data based on postcode)
earned_data <- merge(earned_data, medianincome, by = c("nb_postcode",'nb_suburb','nb_state'), all.x = TRUE)
```

```{r}
density_data <- read_csv('../data/external/MMM areas classification.csv') %>%
  rename(mm_category = MMM)

earned_data <- left_join(earned_data, density_data, by = c("nb_suburb", "nb_postcode", "nb_state"))
```


# Frequency Data

```{r}
claims_count <- claims_data %>% 
  group_by(exposure_id, tenure) %>% 
  summarise(claim_count = n(), .groups = 'drop')

frequency_df <- left_join(earned_data, claims_count, by = c("exposure_id", "tenure"))

frequency_df <- frequency_df %>%
  mutate(claim_count = replace_na(claim_count, 0),
         claim_count_indicator = ifelse(claim_count > 0, 1, 0))
```

# Severity Data

```{r}
#Probably select(c("exposure_id", "tenure", "total_claim_amount"))
severity_df <- left_join(claims_data, earned_data, by = c("exposure_id", "tenure"))

#total claim amount = claim Paid / contribution + excess / gst
#167.07/0.9+100/1.1
#claim paid = (total claim amount - excess / gst ) * contribution

severity_df <- severity_df %>%
  group_by(condition_category, exposure_id) %>%
  mutate(excess_flag = ifelse(row_number() == 1, 1, 0)) %>%
  ungroup()

severity_df <- severity_df %>% 
  mutate(claim_due_excess = (total_claim_amount - (nb_excess)/1.1)*(nb_contribution/100),
         claim_due_no_excess = total_claim_amount*(nb_contribution/100)) %>%
  arrange(claim_start_date, exposure_id, claim_id) 
```


# Joint (Tweedie) Data

```{r}
joint_df <- claims_data %>% 
  group_by(exposure_id, tenure) %>%
  summarise(claim_paid = sum(claim_paid),
            total_claim_amount = sum(total_claim_amount)) %>% 
  full_join(earned_data, by = c("exposure_id", "tenure")) %>%
  mutate(total_claim_amount = replace_na(total_claim_amount, 0),
         claim_paid = replace_na(claim_paid, 0))
```

```{r}
write_csv(frequency_df, "../data/transformed/frequency.csv")

write_csv(severity_df, "../data/transformed/severity.csv")

write_csv(joint_df, "../data/transformed/joint.csv")
```


```{r}
summary(joint_df)
```



